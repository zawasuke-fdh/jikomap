<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>福岡改善版</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
<script id="search-js" defer="" src="https://api.mapbox.com/search-js/v1.0.0-beta.22/web.js"></script>

<style>
body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
header {
    height: 10%;
    background-color: rgba(255, 255, 255, 0.8);
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

header img {
    width: 100px;
    height: auto;
}

#map { flex: 1; width: 100%; }

/* サイドメニュー */
#side-menu {
    position: fixed;
    top: 0;
    right: -60%;
    width: 60%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.95);
    z-index: 20;
    box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
    transition: right 0.3s ease;
    padding: 20px;
    overflow-y: auto;
}

#menu-button {
    background-color: #333;
    color: white;
    padding: 10px;
    font-size: 16px;
    cursor: pointer;
    border: none;
}

.open {
    right: 0;
}

/* ポップアップの罫線スタイル */
.mapboxgl-popup-content table, .mapboxgl-popup-content th, .mapboxgl-popup-content td {
    border: 2px solid black;
    border-collapse: collapse;
}
.mapboxgl-popup-content th, .mapboxgl-popup-content td {
    padding: 8px;
    text-align: left;
}

/* レスポンシブデザイン */
@media (max-width: 600px) {
    .mapboxgl-popup table {
        font-size: 10pt;
    }
    th, td {
        padding: 4px;
    }
    .mapboxgl-popup {
        width: 90%;
        max-height: 100vh;
        overflow-y: auto;
    }
}
</style>
</head>
<body>
<header>
    <div><img src="logo.jpg" alt="Logo"></div>
    <h2>福岡・佐賀・長崎3県 子どもの交通事故マップ</h2>
    <button id="menu-button" onclick="toggleSideMenu()">☰</button>
</header>
<div id="map"></div>
<div id="side-menu">
    <h2>メニュー</h2>
    <p>ああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああああ</p>
</div>
<script>
function isMobileDevice() {
    return window.innerWidth <= 800;
}

// モバイルデバイスとPCで異なる設定
const mobileSettings = {
    center: [130.486, 33.523],
    zoom: 7.5
};

const desktopSettings = {
    center: [130.486, 33.523],
    zoom: 8.75
};

// デバイスによって設定を選択
const settings = isMobileDevice() ? mobileSettings : desktopSettings;

// Mapboxのマップを初期化
mapboxgl.accessToken = 'pk.eyJ1Ijoibm5wZGF0YSIsImEiOiJjbHBnbTV6cXIwd2p2MmlwYWxnYWg1bnh3In0.vDZxaboMvN72PFLaztqqnA';
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/nnpdata/cm49p40iv018h01rd0cy76jcu',
    center: settings.center,
    zoom: settings.zoom
});

// スタイルが読み込まれた後にソースとレイヤーを追加する
map.on('style.load', () => {
    geojsonFiles.forEach(file => {
        fetch(file.url)
            .then(response => response.json())
            .then(geojson => {
                map.addSource(file.id, {
                    type: 'geojson',
                    data: geojson,
                    cluster: true,
                    clusterRadius: 120,
                    clusterMinPoints: 30
                });

                map.addLayer({
                    id: `${file.id}-points`,
                    type: 'circle',
                    source: file.id,
                    filter: ['!', ['has', 'point_count']],
                    paint: {
                        'circle-color': '#808080',
                        'circle-radius': 6,
                        'circle-opacity': 0.5
                    }
                });

                map.addLayer({
                    id: `${file.id}-clusters`,
                    type: 'circle',
                    source: file.id,
                    filter: ['has', 'point_count'],
                    paint: {
                        'circle-color': [
                            'step',
                            ['get', 'point_count'],
                            '#808080', 30,
                            '#FF8000', 50,
                            '#FFB000', 100,
                            '#FFFF00', 300,
                            '#dcdcdc',
                        ],
                        'circle-radius': [
                            'step',
                            ['get', 'point_count'],
                            24, 30,
                            36, 50,
                            48, 100,
                            60, 300,
                            72,
                        ]
                    }
                });

                map.addLayer({
                    id: `${file.id}-cluster-count`,
                    type: 'symbol',
                    source: file.id,
                    filter: ['has', 'point_count'],
                    layout: {
                        'text-field': '{point_count}',
                        'text-size': 12
                    }
                });

                map.on('click', `${file.id}-points`, (e) => {
                    const coordinates = e.features[0].geometry.coordinates.slice();
                    const properties = e.features[0].properties;

                    const popupContent = `
                        <div>
                            <table>
                                <tr><th>発生日時</th><td>${properties["発生日時_掲載"] || '不明'}</td></tr>
                            </table>
                        </div>
                    `;

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(popupContent)
                        .addTo(map);
                });

                map.on('mouseenter', `${file.id}-points`, () => {
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', `${file.id}-points`, () => {
                    map.getCanvas().style.cursor = '';
                });
            })
            .catch(error => console.error(`Error loading ${file.url}:`, error));
    });
});

// サイドメニューのトグル関数
function toggleSideMenu() {
    const sideMenu = document.getElementById('side-menu');
    const isOpen = sideMenu.style.right === '0px';
    sideMenu.style.right = isOpen ? '-60%' : '0';
}
</script>
</body>
</html>
